# ユーザー管理と設定タブの設計

**作成日**: 2025-10-03 01:47
**ステータス**: 設計完了

---

## 📱 アプリ全体のタブ構成（更新版）

アプリ下部に4つのメインタブを配置：

1. **新規入力タブ** - セッションの点数入力
2. **履歴タブ** - 日付ごとのセッション一覧
3. **分析タブ** - ダッシュボード・統計情報
4. **設定タブ** - ユーザー管理・各種設定

---

## 👤 ユーザー管理の基本設計

### ユーザーの種類

**メインユーザー（自分）**：
- アプリ使用者本人
- `isMainUser: true` フラグで識別
- 必須（1名のみ）

**登録ユーザー**：
- 頻繁に一緒に打つ対戦相手
- オプショナル（0名以上）
- よく対戦する相手を登録しておくと入力が楽

### ユーザーデータ構造（例）

```typescript
interface User {
  id: string;              // UUID
  name: string;            // ユーザー名
  isMainUser: boolean;     // メインユーザーフラグ
  createdAt: Date;         // 登録日時
}
```

---

## ⚙️ 設定タブの画面設計

### 設定タブのメニュー

```
┌─────────────────────────────────────┐
│             設定                     │
├─────────────────────────────────────┤
│                                     │
│ 👤 ユーザー管理                      │
│    登録ユーザーの追加・編集・削除    │
│    ────────────────────            │
│                                     │
│ 🎲 ウマルール設定                    │
│    4人打ち・3人打ちのウマ割り当て    │
│    ────────────────────            │
│                                     │
│ 🎨 表示設定（今後実装予定）          │
│    テーマ、フォントサイズなど        │
│    ────────────────────            │
│                                     │
│ 💾 データ管理（今後実装予定）        │
│    バックアップ、エクスポートなど    │
│    ────────────────────            │
│                                     │
│ ℹ️  アプリ情報（今後実装予定）       │
│    バージョン、利用規約など          │
│                                     │
└─────────────────────────────────────┘
```

---

## 👤 ユーザー管理画面

### ユーザー一覧画面

```
┌─────────────────────────────────────┐
│ ← 設定          ユーザー管理         │
├─────────────────────────────────────┤
│                                     │
│ ⭐ 自分（メインユーザー）            │
│    [編集]                            │
│ ────────────────────────────────    │
│                                     │
│ 📝 登録ユーザー                      │
│                                     │
│  ┌─────────────────────────┐       │
│  │ 田中太郎            [編集] [削除] │       │
│  └─────────────────────────┘       │
│                                     │
│  ┌─────────────────────────┐       │
│  │ 佐藤花子            [編集] [削除] │       │
│  └─────────────────────────┘       │
│                                     │
│  ┌─────────────────────────┐       │
│  │ 山田次郎            [編集] [削除] │       │
│  └─────────────────────────┘       │
│                                     │
│ ────────────────────────────────    │
│ [+ 新規ユーザー追加]                 │
│                                     │
└─────────────────────────────────────┘
```

### ユーザー編集画面

```
┌─────────────────────────────────────┐
│ ← 戻る        ユーザー編集           │
├─────────────────────────────────────┤
│                                     │
│ 名前:                                │
│ [田中太郎_________________________] │
│                                     │
│ ────────────────────────────────    │
│                                     │
│            [保存]  [キャンセル]      │
│                                     │
└─────────────────────────────────────┘
```

---

## 🎲 ウマルール設定画面

### ウマルール設定

```
┌─────────────────────────────────────┐
│ ← 設定          ウマルール設定       │
├─────────────────────────────────────┤
│                                     │
│ 【4人打ち】                          │
│                                     │
│ ○ 標準ルール                         │
│   1位:○○ 2位:○ 3位:✗ 4位:✗✗      │
│                                     │
│ ○ 2位マイナス判定ルール               │
│   2位がマイナス → 1位:○○○ 2位:無印  │
│   2位がプラス   → 1位:○○ 2位:○     │
│                                     │
│ ────────────────────────────────    │
│                                     │
│ 【3人打ち】                          │
│                                     │
│ ○ 標準ルール                         │
│   1位:○○ 2位:○ 3位:✗✗✗           │
│                                     │
│ ○ 2位マイナス判定ルール               │
│   2位がマイナス → 1位:○○○ 2位:✗    │
│   2位がプラス   → 1位:○○ 2位:○     │
│                    3位:✗✗✗         │
│                                     │
│ ────────────────────────────────    │
│                                     │
│            [保存]  [キャンセル]      │
│                                     │
└─────────────────────────────────────┘
```

**設定項目**：
- **4人打ち**：標準ルール or 2位マイナス判定ルール
- **3人打ち**：標準ルール or 2位マイナス判定ルール

**デフォルト**：
- 4人打ち：標準ルール
- 3人打ち：標準ルール

**ウマの合計原則**：
- どのルールでも○と✗の合計数が一致（ゼロサム）
- 4人打ち：○3つ、✗3つ
- 3人打ち：○3つ、✗3つ

---

## 📊 成績分析タブでのユーザー選択

### 更新された画面構成

```
┌─────────────────────────────────────┐
│ ユーザー: [自分 ▼]  期間: [今月 ▼]  │
│ [4人打ち] [3人打ち] [全体]           │
├─────────────────────────────────────┤
│                                     │
│ 📊 着順統計（50半荘）                │
│ ────────────────────────────────    │
│ 1位: 15回 (30.0%)  ████████████     │
│ 2位: 12回 (24.0%)  █████████        │
│ ...                                 │
└─────────────────────────────────────┘
```

**ユーザー選択ドロップダウン**：
- デフォルト：「自分」を選択
- 選択肢：メインユーザー + 登録ユーザー全員
- 選択すると、そのユーザーの統計が表示される

**統計の計算対象**：
- 選択したユーザーが参加した全セッション・全半荘
- プレイヤー列の位置は問わない（自分が左端とは限らない）

---

## 🎯 新規入力タブでのユーザー選択

### プレイヤー名の入力方法

入力画面の表で、プレイヤー名をタップすると選択画面：

```
┌─────────────────────────────────────┐
│       プレイヤーを選択               │
├─────────────────────────────────────┤
│                                     │
│  ⭐ 自分                             │
│  田中太郎                            │
│  佐藤花子                            │
│  山田次郎                            │
│  ────────────────────              │
│  [新規プレイヤー入力]                │
│                                     │
└─────────────────────────────────────┘
```

**選択肢**：
- メインユーザー（自分）
- 登録ユーザー一覧
- 新規プレイヤー入力（その場限りの名前）

**デフォルト**：
- 1列目：必ず「自分」
- 2-4列目：未選択（A, B, C等の仮名）

---

## 💾 データ保存の仕組み

### セッションデータとユーザーの関連

各セッション・各半荘で、参加したユーザーのIDを記録：

```typescript
interface Hanchan {
  hanchanNumber: number;
  players: {
    userId: string;      // ユーザーID（登録ユーザー or null）
    playerName: string;  // 表示名（登録ユーザーの名前 or 仮名）
    score: number;       // ±点数
    umaMarks: string;    // ウママーク
    isSpectator: boolean; // 見学フラグ
  }[];
}
```

**ポイント**：
- `userId` が null の場合：その場限りのプレイヤー（統計に含めない）
- `userId` がある場合：登録ユーザー（統計に含める）

---

## 📋 ユーザー管理の機能要件

### ユーザー登録の2つの方法

**方法1: 入力画面での自動登録（推奨）**：
- プレイヤー名選択時に新しい名前を入力
- 入力と同時に自動的に新規ユーザーとして登録
- 次回以降、選択肢に表示される
- 最もシンプルで自然な登録方法

**方法2: 設定タブでの事前登録（オプション）**：
- 設定タブから事前にユーザーを登録
- 対戦前に登録しておきたい場合に使用

### 基本機能

**ユーザー編集**：
- 名前の変更可能
- 過去のデータも自動的に更新される（IDで紐付け）
- タイプミスや表記変更に対応

**ユーザー削除**：
- 確認ダイアログ表示
- 削除後も過去のデータは残る（名前のみ表示）
- 統計からは除外される

**メインユーザー編集**：
- 名前のみ変更可能
- 削除不可

**重複チェック**：
- 同じ名前のユーザーが既に存在する場合は警告
- 既存ユーザーとの統合を提案

---

## 🚀 次のステップ

1. データモデル設計（Dexie.js）
   - User テーブル
   - Session テーブル
   - Hanchan テーブル
2. 設定タブの実装
3. ユーザー選択機能の実装

---

**更新履歴**:
- 2025-10-03 02:05: 3人打ちの2位マイナス判定ルールを追加、ウマの合計原則を明記
- 2025-10-03 02:03: ウマルール設定画面を追加（4人打ちの2位マイナス判定ルール対応）
- 2025-10-03 01:50: 自動登録機能を明記、入力画面での登録を推奨方法に変更
- 2025-10-03 01:47: 初回作成、ユーザー管理と設定タブの設計完了
