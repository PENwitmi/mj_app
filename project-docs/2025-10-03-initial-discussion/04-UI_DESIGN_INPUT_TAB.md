# 新規入力タブの画面設計

**作成日**: 2025-10-03 01:18
**ステータス**: 設計完了

---

## 📱 アプリ全体のタブ構成

アプリ下部に4つのメインタブを配置：

1. **新規入力タブ** - セッションの点数入力
2. **履歴タブ** - 日付ごとのセッション一覧
3. **分析タブ** - ダッシュボード・統計情報
4. **設定タブ** - ユーザー管理・各種設定

---

## 🎮 入力モード選択

### モード選択画面

新規入力タブに入ると、まず対局モードを選択：

```
┌─────────────────────────────────────┐
│         新規セッションを開始         │
├─────────────────────────────────────┤
│                                     │
│   ┌───────────────────────┐         │
│   │      4人打ち麻雀       │         │
│   └───────────────────────┘         │
│                                     │
│   ┌───────────────────────┐         │
│   │      3人打ち麻雀       │         │
│   └───────────────────────┘         │
│                                     │
└─────────────────────────────────────┘
```

### 各モードの特性

**4人打ち麻雀**:
- 全ての半荘が4人で対局
- ゼロサム：合計点 = 0
- 着順：1位〜4位
- 統計：4人打ちとして集計

**3人打ち麻雀**:
- 全ての半荘が3人で対局
- ゼロサム：合計点 = 0
- 着順：1位〜3位
- 統計：3人打ちとして集計

### モードの重要性

**統計分析のため必須**：
- 4人打ちの3位と3人打ちの3位では意味が全く異なる
- 後の成績分析で正確な統計を出すため、モード情報が必要
- セッションごとにモードを記録

---

## 🎯 新規入力タブの詳細設計

### 画面上部（設定エリア）

コンパクトに表示される設定フォーム：

```
┌─────────────────────────────────────┐
│ 📅 2025-10-03 (本日/編集可)          │
│ レート: [_100_]  ウマ: [__10__] (×) │
│ チップレート: [_100_]  場代: [500]円│
└─────────────────────────────────────┘
```

**項目**：
- **日付**: 自動的に本日の日付（編集可能）
- **レート**: 点数を円に換算する際の係数
- **ウマ**: ウママーク1個あたりの価値
- **チップレート**: チップ1枚あたりの価値（円）
- **場代**: 雀荘の使用料（円）

---

### メイン表示エリア（表形式）

横スクロール可能な表形式でデータ入力：

```
┌──────┬──┬─────────┬─────────┬─────────┬─────────┐
│      │[+]│  自分   │   B     │   C     │   D     │ ← プレイヤー名
├──────┼──┼─────────┼─────────┼─────────┼─────────┤
│ 1半荘│  │ +10 ○○ │  -5 ○  │ -20 ✗✗ │ +15 ✗  │ ← 自動計算（3人入力後）
├──────┼──┼─────────┼─────────┼─────────┼─────────┤
│ 2半荘│  │  +5 ○  │ +10 ○○ │ -10 ✗  │  -5 ✗✗ │
├──────┼──┼─────────┼─────────┼─────────┼─────────┤
│ [+ 行追加]                                    │
├══════╪══╪═════════╪═════════╪═════════╪═════════┤ ← 固定エリア
│小計  │  │+45      │+25      │-60      │-10      │
│      │  │(+15+30) │(+5+20)  │(-30-30) │(+10-20) │
│チップ│  │[__+2__] │[__-1__] │[__0__]  │[__-1__] │ ← 入力欄
│収支  │  │ +4700   │ +2400   │ -6000   │ -1100   │
│場代  │  │  -500   │  -500   │  -500   │  -500   │
│━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━│
│最終  │  │ +4200   │ +1900   │ -6500   │ -1600   │
└──────┴──┴─────────┴─────────┴─────────┴─────────┘
```

### 抜け番対応（5人で4人打ち等）

**人数追加ボタン**：
- 配置：プレイヤー名行の左端（`[+]`ボタン）
- 機能：クリックで列を追加（E, F, G...）
- 用途：5人で4人打ち、4人で3人打ちなど

**抜け番の例（5人で4人打ち）**：
```
┌──────┬──┬─────────┬─────────┬─────────┬─────────┬─────────┐
│      │[+]│  自分   │   B     │   C     │   D     │   E     │
├──────┼──┼─────────┼─────────┼─────────┼─────────┼─────────┤
│ 1半荘│☑ │  見学   │  +5 ○  │ +10 ○○ │ -15 ✗✗ │   0 ✗  │
├──────┼──┼─────────┼─────────┼─────────┼─────────┼─────────┤
│ 2半荘│  │ +10 ○○ │  -5 ○  │ -20 ✗✗ │ +15 ✗  │  見学   │
├──────┼──┼─────────┼─────────┼─────────┼─────────┼─────────┤
│ 3半荘│  │  +8 ○  │ +20 ○○ │  -2 ○  │ -26 ✗✗ │  見学   │
```

**見学チェックボックス**：
- **表示条件**：設定人数を超えた場合のみ表示
  - 4人打ち：5人目以降を追加した場合
  - 3人打ち：4人目以降を追加した場合
  - 設定人数以内：チェックボックスは非表示
- **配置**：各半荘行の左端（`[+]`列）
- **機能**：☑チェックで「見学」扱い
- **効果**：
  - チェック後、そのプレイヤーのセルは計算対象外
  - 見学中のセルには「見学」と表示
  - 自動計算は見学者を除いた参加者で実行
  - 半荘ごとに誰が見学するかを切り替え可能

---

## 🧮 計算ロジック

### ゼロサム原則に基づく自動計算

**基本原則**：
- 麻雀は全プレイヤーの点数合計が0になる（ゼロサム）
- この特性を利用して、最後の1人の点数を自動計算

**自動計算のタイミング**：
- 4人打ち：3人入力完了 → 4人目を自動計算
- 3人打ち：2人入力完了 → 3人目を自動計算
- 見学者がいる場合：見学者を除いた参加者数で判定

**自動計算ロジック（初回1回限り）**：

```typescript
// 各半荘ごとに管理
{
  hanchan: 1,
  autoCalculated: false,  // 自動計算済みフラグ
  scores: [10, -5, -20, 15],
  umaMarks: ['○○', '○', '✗✗', '✗'],
  spectators: [false, false, false, false]  // 見学フラグ
}
```

**自動計算の動作**：
1. **初回自動計算**：
   - 必要人数-1人の入力完了で最後の1人を自動計算
   - 計算後、`autoCalculated = true` に設定

2. **自動計算後の編集**：
   - すでに全員分入力済み（自動計算含む）
   - どれかのセルを修正・削除しても**再計算しない**
   - 理由：どのセルを基準に再計算すべきか不明確

3. **手動リセット**：
   - 全セルを削除して再入力すれば、再び自動計算が発動
   - `autoCalculated = false` にリセット

**編集の柔軟性**：
- 自動計算された値も手動で上書き可能
- 誰がトップか（計算式の基準）は途中で変更可能
- すべてのセルが編集可能

### 各行（半荘）の入力

**点数入力**：
- ±形式で入力（例：+10 = 40000点）
- 計算式: `(終了点数 - 30000) / 1000`

**ウママークの扱い**：
- **自動割り当て**：点数入力時、設定されたルールに従って自動で割り当て
- **手動変更可能**：ウママークをタップして選択・変更
  ```
  タップすると選択メニュー：
  ○○○
  ○○
  ○
  無印
  ✗
  ✗✗
  ✗✗✗
  ```
- **変更のタイミング**：
  - 点数入力時：自動で割り当て
  - 点数変更時：再計算して自動で更新
  - 手動変更後：自動更新しない（手動優先）
- **理由**：設定されたルールだけでは対応できないケースがあるため

### 固定エリアの計算フロー

1. **合計点**: 各半荘の点数の合計（例：+10 + +5 = +15）
2. **ウマ**: マークの合計 × ウマ価値
   - 例：(○○ + ○) = +3個 → 3 × 10 = +30
3. **小計**: 合計点 + ウマ
   - 表示: `+45 (=+15+30)` のように内訳を括弧で表示
4. **チップ**: 全半荘終了後に入力（入力欄）
5. **収支**: (小計 × レート) + (チップ × チップレート)
   - 例：(+45 × 100) + (+2 × 100) = +4700
6. **場代**: 雀荘の使用料（全員一律）
7. **最終収支**: 収支 - 場代
   - 例：+4700 - 500 = +4200

---

## 📝 プレイヤー名の扱い

### 基本原則
- **1列目（左端）**: 必ず「自分」（メインユーザー）
- **2列目以降**: 未選択（A、B、C等の仮名）またはユーザー選択

### プレイヤー名の選択方法

プレイヤー名セルをタップすると選択画面が表示：

```
┌─────────────────────────────────────┐
│       プレイヤーを選択               │
├─────────────────────────────────────┤
│  ⭐ 自分                             │
│  田中太郎                            │
│  佐藤花子                            │
│  山田次郎                            │
│  ────────────────────              │
│  [新規プレイヤー入力]                │
└─────────────────────────────────────┘
```

**選択肢**：
- **メインユーザー**：「自分」（1列目専用）
- **登録済みユーザー**：既に登録されているユーザー一覧
- **[新しい名前を入力...]**：新規ユーザーを入力

### ユーザー管理との連携

**新規ユーザーの自動登録**：
- 「新しい名前を入力...」を選択して名前を入力
- **入力と同時に自動的にユーザーとして登録**
- 次回以降、選択肢に表示される
- 統計にも自動的に反映される
- 設定タブで後から編集・削除可能

**既存ユーザーの選択**：
- 入力時に名前を選択するだけ
- 自動的に統計データに反映
- 成績分析タブで個別統計が見られる

**重複チェック**：
- 同じ名前のユーザーが既に存在する場合は警告
- 既存ユーザーとの統合を提案

詳細は `07-USER_MANAGEMENT_AND_SETTINGS.md` を参照

---

## 🎨 UI/UX 要件

### レイアウト
- **コンパクト化**: 1行に点数とウママークを横並びで表示
- **固定エリア**: スクロール時も計算結果が常に見える
- **行追加**: ボタンで半荘を追加

### 入力体験
- **点数入力**: ±形式で簡潔に（例：+10）
- **ウママーク**: 自動割り当て（点数順）
- **編集可能**: ウママークは後から変更可能
- **チップ入力**: 全半荘終了後にまとめて入力

### ウマ自動割り当てルール（後ほど詳細決定）
- 4人打ち例：1位→○○、2位→○、3位→✗、4位→✗✗
- 点数順に自動で付与
- 同点の場合のルールは今後決定

---

## 🚀 次のステップ

1. この画面設計を元にコンポーネント実装
2. Dexie.jsでデータモデル設計
3. 過去の履歴タブの設計
4. 成績分析タブの設計

---

**更新履歴**:
- 2025-10-03 02:08: ウママークの手動変更機能を詳細化（タップして選択メニュー）
- 2025-10-03 01:50: プレイヤー名入力時の自動登録機能を明記
- 2025-10-03 01:47: ユーザー管理機能との連携、プレイヤー選択方法更新、タブ構成を4つに変更
- 2025-10-03 01:36: モード選択（4人/3人）、人数追加機能、見学機能、自動計算ロジック追加、フリーモード削除
- 2025-10-03 01:18: 初回作成、新規入力タブの画面設計完了
